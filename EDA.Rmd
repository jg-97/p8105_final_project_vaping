---
output: 
  html_document:
    theme: journal
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      fig.height = 5,
                      fig.width = 10)
library(tidyverse)
library(gganimate)
library(transformr)
library(gifski)
library(magick)
library(reprex)
library(modelr)
library(glmnet)
library(patchwork)
###This package provide glm like interface for glmnet
library(glmnetUtils)
set.seed(8105)

theme_set(theme_bw())
```



<br> <br>


# Exploratory Analysis

<br>


```{r load_the_cleaned_data, echo=FALSE}
### load the cleaned data
load("./data/nyc_data.RData")
nyc_drug <- df_total

```

## Exploring the change of Vaping and other drug use over Time

<br>

In order to analyze the change of vaping and other drug usage over time in NYC's youth, we created the following animated plot:

<br>

```{r distribution_vaping_other_drugs, echo=FALSE}
## filter the data used in this part
nyc_drug_used <- nyc_drug %>% 
  select(id, borough, year, 
         cigarette = current_cigarette_use, cigar = current_cigar_use,
         alcohol = current_alcohol_use, marijuana = current_marijuana_use,
         vaping = current_vaping) %>% 
  mutate(year = factor(year))

## cigarette proportion
cigarette <- nyc_drug_used %>% 
  filter(!is.na(cigarette)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            cigarette = sum(cigarette == "Yes")/n) %>% 
  select(-n)

## cigar proportion
cigar <- nyc_drug_used %>% 
  filter(!is.na(cigar)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            cigar = sum(cigar == "Yes")/n) %>% 
  select(-n) 

## alcohol proportion
alcohol <- nyc_drug_used %>% 
  filter(!is.na(alcohol)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            alcohol = sum(alcohol == "Yes")/n) %>% 
  select(-n) 


## vaping proportion 
vaping <- nyc_drug_used %>% 
  filter(!is.na(vaping)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            vaping = sum(vaping == "Yes")/n) %>% 
  select(-n) 

## marijuana proportion with all other proportions
marijuana_full <- nyc_drug_used %>% 
  filter(!is.na(marijuana)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            marijuana = sum(marijuana == "Yes")/n) %>% 
  select(-n) %>% 
  left_join(cigarette, by = c("year", "borough")) %>% 
  left_join(cigar, by = c("year", "borough")) %>% 
  left_join(alcohol, by = c("year", "borough")) %>% 
  left_join(vaping, by = c("year", "borough")) %>% 
  pivot_longer(marijuana:vaping,
               names_to = "drug_type",
               values_to = "proportion")

drug_p <- marijuana_full %>%
  filter(!(is.na(proportion))) %>%
  ggplot(aes(x = year, y = proportion, color = borough, shape = drug_type, 
             group = interaction(borough, drug_type), frame = drug_type)) +
  geom_point(size = 2.2) + geom_path(size = .8) +
  labs(title = "{closest_state}",
       x = "Year",
       y = "Proportion of drug use",
       color = "Borough",
       shape = "Drug type") +
  theme(plot.title = element_text(size = 30, face = "bold"),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15,face = "bold")) + 
  theme(legend.text = element_text(size = 10), legend.title = element_text(size = 15, face = "bold")) +  
  transition_states(drug_type, transition_length = 1, state_length = 3, wrap = TRUE) +
  enter_fade() + exit_fade()

animate(drug_p)
```

After analyzing the plot, we drew the following conclusions:

* Among the five types of drugs considered, alcohol has the highest proportion in year 2003, but started decreasing in use from 2007 onwards across all five boroughs in NYC. In addition, cigarette has a lower total proportion than alcohol but a similar decreasing trend after 2009. 

* Cigar maintains a steady but low-proportion trend during 2003-2017, which could be compared with marijuana holding a steady but higher proportion in total. Moreover, the marijuana use in Manhattan increased from the lowest level in 2007 to the highest level in 2011 among five boroughs. 

* Staten Island had the highest Marijuana use over the years among all five NYC boroughs. However, in year 2017, it dropped dramatically and had the lowest proportion among all boroughs. Overall Marijuana stayed almost the same among all boroughs over the years. 

* Vaping, which is our main drug of interest, has a slightly increasing trend from 2015-2017. This trend is quite similar to the alcohol, cigar and cigarette trend observed from 2003 to 2005, and has a proportion about as high as the proportion observed in marijuana in 2015-2017, which indicates that it could possibliy grow into a new drug threatening public health.

<br> <br>

## Exploring the change of Mental Health over Time
<br>

In order to analyze the change of mental health status of NYC's youth over time, we created the following animated plot:

<br>

```{r distribution_mental_health, echo=FALSE}
## data for mental health disorder
nyc_drug_health <- nyc_drug %>% 
  select(id, year, borough, sad = sad_hopeless, 
         suicide = attempted_suicide, injury = injurious_suicide_attempt) %>% 
  mutate(year = factor(year))

## sadless
sad <- nyc_drug_health %>% 
  filter(!is.na(sad)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            sad = sum(sad == "Yes")/n) %>% 
  select(-n)

## attempted suicide
suicide <- nyc_drug_health %>% 
  filter(!is.na(suicide)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            suicide = sum(suicide == "Yes")/n) %>% 
  select(-n)

## injurious attempted suicide
injury_full <- nyc_drug_health %>% 
  filter(!is.na(injury)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            injury = sum(injury == "Yes")/n) %>% 
  select(-n) %>% 
  left_join(sad, by = c("year", "borough")) %>% 
  left_join(suicide, by = c("year", "borough")) %>% 
  pivot_longer(injury:suicide,
               names_to = "mental_disorder",
               values_to = "proportion")

## animated plot
mental_p <- injury_full %>%
  filter(!(is.na(proportion))) %>% 
  ggplot(aes(x = year, y = proportion, color = borough, shape = mental_disorder, 
             group = interaction(borough, mental_disorder))) +
  geom_point(size = 2.2) + geom_path(size = .8) +
  labs(x = "Year",
       y = "Proportion of mental disorder",
       color = "Borough",
       shape = "Mental disorder") +  
  scale_shape_discrete(labels = c("injurious attempted suicide", "sad and hopeless", "attempted suicide")) +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15,face = "bold")) + 
  theme(legend.text = element_text(size = 10), legend.title = element_text(size = 15, face = "bold"))  +
  transition_states(mental_disorder, transition_length = 1, state_length = 3, wrap = TRUE) +
  enter_fade() + exit_fade()

animate(mental_p)

```

Examining this plot, we determined the following:

* Teenagers, feeling sad and hopeless, constitute the highest proportion among all three mental health issues considered. Based on the considered survey data, we see that a high percentage of teenagers do not have a positive mood. The trend decreases slightly after 2009, just to pick up again in 2015. Staten Island has the lowest proportion in the reported sadness with the exception of 2011. Bronx almost alwyas has the highest proportion, and Queens fluctuates greatly.

* The proportion of attempted suicide is approximately constant at about 0.1 and is higher than the proportion associated with getting injured due to an attempted suicide. Both attempted suicide and injurious attempted suicide are relatively steady over time and have about the same magnitude across all five NYC boroughs. 




<br> <br>

## Exploring drug use in 2017 by sex within each borough
<br>

We were interested in whether there is a difference in drug use between female and male teenagers in different boroughs in NYC in 2017. To that end, we created the following plots:

<br>

```{r Drug_Use_2017_by_Sex, echo=FALSE}
sex_plot = function(df, borough) {
df %>% 
  select(
    sex, 
    current_vaping, 
    current_cigarette_use, 
    current_cigar_use, 
    current_alcohol_use, 
    current_marijuana_use) %>% 
  pivot_longer(
    -sex,
    names_to = "drug",
    names_prefix = "current_",
    values_to = "status") %>% 
  mutate(
    drug = str_replace(drug, "_use", "")) %>%
  drop_na() %>% 
  group_by(
    drug,
    sex
  ) %>% 
  summarize(
    number = n()
  ) %>% 
  ungroup() %>% 
  group_by(drug) %>% 
  mutate(
    number_in_group = sum(number),
    percent = number / number_in_group) %>% 
  select(-number, -number_in_group) %>% 
  ggplot(aes(x = sex, y = percent, fill = sex)) + 
  geom_bar(stat = "identity") +
  labs(
    title = str_c("Drug Use in 2017 by Sex in ", borough),
    x = "sex",
    y = "proportion of drug use") + 
  theme(legend.position = "none") +
  facet_grid(~drug)}

sex_Bronx = sex_plot(nyc_drug %>% filter(year == "2017" & borough == "Bronx")," - The Bronx")
sex_Brooklyn = sex_plot(nyc_drug %>% filter(year == "2017" & borough == "Brooklyn"), " - Brooklyn")
sex_Manhattan = sex_plot(nyc_drug %>% filter(year == "2017" & borough == "Manhattan"), " - Manhattan")
sex_Queens = sex_plot(nyc_drug %>% filter(year == "2017" & borough == "Queens"), " - Queens")
sex_Staten_Island = sex_plot(nyc_drug %>% filter(year == "2017" & borough == "Staten Island"), " - Staten Island")
```


## {.tabset .tabset-fade .tabset-pills}

### **Bronx**
```{r echo=FALSE}
sex_Bronx
```

### **Brooklyn**
```{r echo=FALSE}
sex_Brooklyn
```

### **Manhattan**
```{r echo=FALSE}
sex_Manhattan
```

### **Queens**
```{r echo=FALSE}
sex_Queens
```

### **Staten Island**
```{r echo=FALSE}
sex_Staten_Island
```



Studying these plots, we were able to derive the following results:

* According to our survey data, it appears as if independent of the type of drug the proportion of male teenagers in the Bronx using a particular type of drug is higher (about 0.55) compared to their female counterparts.

* According to our survey data, it appears as if independent of the type of drug the proportion of female teenagers in Brooklyn using a particular type of drug is higher (about 0.55) compared to their male counterparts.

* According to our survey data, it appears as if independent of the type of drug the proportion of female teenagers in Manhattan using a particular type of drug is higher (almost 0.60) compared to their male counterparts.

* According to our survey data, it appears as if independent of the type of drug the proportion of female teenagers in  Queens using a particular type of drug is about equal to the proportion of their male counterparts. A similar trend can be observed in Staten Island. However it seems as if marijuana use is slightly higher in female than in males teenagers in Staten Island.


<br><br>

## Exploring drug use in 2017 by being involved in fights
<br>

We were interested in whether there is a difference in drug use between teenagers involved in fights and teenagers not involved in fights in different boroughs of NYC in 2017. To that end, we created the following plots:

<br>

```{r Drug_Use_2017_by_Feeling_Sad_Hopeless, echo=FALSE}
fight_plot = function(df, borough) {
df %>% 
  select(
    physical_fighting, 
    current_vaping, 
    current_cigarette_use, 
    current_cigar_use, 
    current_alcohol_use, 
    current_marijuana_use) %>% 
  pivot_longer(
    -physical_fighting,
    names_to = "drug",
    names_prefix = "current_",
    values_to = "status") %>% 
  mutate(
    drug = str_replace(drug, "_use", "")) %>%
  drop_na() %>% 
  group_by(
    drug,
    physical_fighting
  ) %>% 
  summarize(
    number = n()
  ) %>% 
  ungroup() %>% 
  group_by(drug) %>% 
  mutate(
    number_in_group = sum(number),
    percent = number / number_in_group) %>% 
  select(-number, -number_in_group) %>% 
  ggplot(aes(x = physical_fighting, y = percent, fill = physical_fighting)) + 
  geom_bar(stat = "identity") +
  labs(
    title = str_c("Drug Use in 2017 by Being Involved in a Fight or Not ", borough),
    x = "involved in a fight",
    y = "proportion of drug use") +  
  theme(legend.position = "none") +
  facet_grid(~drug)}



fight_Bronx = fight_plot(nyc_drug %>% filter(year == "2017" & borough == "Bronx")," - The Bronx")
fight_Brooklyn = fight_plot(nyc_drug %>% filter(year == "2017" & borough == "Brooklyn"), " - Brooklyn")
fight_Manhattan = fight_plot(nyc_drug %>% filter(year == "2017" & borough == "Manhattan"), " - Manhattan")
fight_Queens = fight_plot(nyc_drug %>% filter(year == "2017" & borough == "Queens"), " - Queens")
fight_Staten_Island = fight_plot(nyc_drug %>% filter(year == "2017" & borough == "Staten Island"), " - Staten Island")
```


## {.tabset .tabset-fade .tabset-pills}

### **Bronx**
```{r echo=FALSE}
fight_Bronx
```

### **Brooklyn**
```{r echo=FALSE}
fight_Brooklyn
```

### **Manhattan**
```{r echo=FALSE}
fight_Manhattan
```

### **Queens**
```{r echo=FALSE}
fight_Queens
```

### **Staten Island**
```{r echo=FALSE}
fight_Staten_Island
```



Studying these plots, we were able to derive the following result:

* According to our survey data, it appears as if independent of the type of drug the proportion of teenagers involved in a fight in the Bronx is about 0.28, with the exception of alcohol, for which the proportion seems to be about 0.25.

* The same trend can be observed in Brooklyn. The only differences appear to be that the proportions itself are a bit lower: 0.22 for alcohol and about 0.25 for the remaining types of drugs.

* According to our survey data, it appears as if independent of the type of drug the proportion of teenagers involved in a fight in Manhatten is about 0.22.

* According to our survey data, it appears as if the proportion of teenagers involved in a fight in Queens is slightly higher for children vaping (about 0.24) and smoking cigars (about 0,23). 

* According to our survey data, it appears as if independent of the type of drug the proportion of teenagers involved in a fight in Staten Island is about 0.19 - the lowest proportion of all boroughs.

<br>

**If this Exploratory Analysis sparked your interested, feel free to explore the data more using the Explore the Data tab on the top right corner of the website.**


