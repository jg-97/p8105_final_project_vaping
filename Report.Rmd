---
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: journal
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      fig.height = 5,
                      fig.width = 10)
library(tidyverse)
library(gganimate)
library(transformr)
library(gifski)
library(magick)
library(reprex)
library(modelr)
library(glmnet)
###This package provide glm like interface for glmnet
library(glmnetUtils)
set.seed(8105)

theme_set(theme_bw())
```

<br>

# Motivation & Related Work

<br>

Vaping, the inhaling of a vapor created by vaping devices like e-cigarettes, was initially regarded as a less harmful substitution for cigarettes. However, vaping still introduces nicotine into the body. The prevalence of lung damage caused by vaping is actually so high that the CDC[[1](https://www.sciencedirect.com/science/article/pii/S2213260019304096?via=ihub)] needed to issue guidance explicitly on it. According to the New York Post, a second vaping related death occured on November 9th, 2019. Overall, vaping has claimed at least 42 lives and injured over 2,000 others across the country[[2](https://nypost.com/2019/11/20/second-new-yorker-dead-from-vaping-related-illness-officials/)]. 

As the popularity of vaping grows, concerns about vaping are covered both in academia and in the press[[3](https://health.usnews.com/health-care/for-better/articles/2018-06-13/how-teenage-vaping-puts-structure-in-place-for-heroin-and-cocaine-addiction),[4](https://www.cnn.com/2015/09/04/us/vaping-abuse/index.html)]. A journal article published recently even describes the prevalence of vaping in a "red alert" state[[5](https://link.springer.com/article/10.1057/s41271-019-00193-2)]. In press, vaping is accused of being both a  gateway drug and a new "drug" itself.  81% of Americans report that teenagers who would not smoke cigarettes are using flavored e-cigarettes[[6](https://www.kff.org/other/issue-brief/data-note-vaping-and-e-cigarettes/)]. To provide grounds for potential public health interventions targeting this "scourge of drug"[[6](https://www.cnn.com/2015/09/04/us/vaping-abuse/index.html)], we evaluated the current landscape of vaping usage among teenagers and young adults in NYC using pre-collected data and analyzed the relation between vaping and other drug usage with mental health and risky/violent behaviors.

<br>

**Facts about vaping**

* 2,051 reported lung illness cases and 39 lung illness deaths due to vaping.[[1](https://www.engadget.com/2019/11/07/cdc-confirms-vaping-lung-injury/)]

* 81% Americans report teenagers who would not smoke cigarettes are using flavored e-cigarettes.[[2](https://www.kff.org/other/issue-brief/data-note-vaping-and-e-cigarettes/)]

* Most popular e-cigarette product introduces with a 5% nicotine up to 2.7 times delievering nicotine than others.[[3](https://truthinitiative.org/research-resources/emerging-tobacco-products/how-much-nicotine-juul)]

According to reports in recent years, we can see an underlying trend of vaping is increasing, especially in the teenager group.


<br> <br>

# Initial Questions

<br>

1. How did drug use change over time in NYC's youth?

2. How did mental health related issues change over time in NYC's youth?

3. How does drug use and mental health status differ by demographics in NYC's youth?

4. How do risky and violent behaviors differ between NYC children using drugs and not using drugs?

5. Can we build a model with current available data to predict future vaping use?
 
<br>

Initially, we were interested in building a model to determine associations. However, as our studies in data science class progressed further, we learned new great procedures and methods that we wanted to incorporate into our project. In particular, we became interested in building a predictive model based on data from 2015, and using this data to predict vaping for 2017

<br> <br>

# Data

<br>

We utilized the **YRBSS** dataset publicly available on [CDC.gov](https://www.cdc.gov/healthyyouth/data/yrbs/data.htm). The YRBSS started in 1990 with the goal to monitor health behaviors that contribute markedly to the leading causes of death, disability, and social issues among youth and adults in the United States. The YRBSS monitors behaviors surrouning, for example,

* Alcohol and other drug use
* Tabacco use
* Unhealthy dietry behaviors
* Physical activity 
* Sexuality and birth control

Between 1991 and 2017, the YRBSS has gathered data from more than 4.4 million high school students in more than 1900 separate surveys. 

Since the dataset is quite extensive - it contains national, state, and district wide data - we decided to focus on data from New York City and investigate youth behaviors related to drug use.

In particular, we downloaded the [Districts(zip)](https://www.cdc.gov/healthyyouth/data/yrbs/data.htm) data in the Access file format. Subsequently, we used **Microsoft Access 2019**, to extract the data pertaining to the five boroughs of NYC. Since **Microsoft Access 2019** only allowed for a maximum of 65000 observations to be exported as an Excel document at once, we ended up with five Excel documents - one for each borough. These datasets can be found [here](https://github.com/jg-97/p8105_final_project_vaping/tree/master/raw_data). Finally, we used R to combine these five datasets and to select variables of interest to us. These variables provided insights into drug usage behaviors, included risky and violent behaviors, and pertained towards mental health, and demographics. While picking suitable variables, we also took into account the response rates (how many missing values are present in a certain variable in a particular year).

In the end, we worked with the following variables:

**Demographics**

* *borough*:   one of the five boroughs of NYC
* *year*:   year of the survey
* *age*:   age of the subject
* *sex*:   gender of the subject (male, female)
* *race7*:   race of the subject

**Drug Use**

* *current_cigarette_use*:   smoked cigarettes during the past 30 days   (Yes/No)
* *current_vaping*:   used an electronic vapor product during the past 30 days   (Yes/No)
* *current_cigar_use*:   smoked cigars, cigarillos, or little cigars during the past 30 days   (Yes/No)
* *current_alcohol_use*:   had at least one drink of alcohol during the past 30 days   (Yes/No)
* *current_marijuana_use*:   used marijuana during the past 30 days   (Yes/No)


**Mental Health**

* *sad_hopeless*:   during the past 12 months, felt so sad or hopeless almost every day for two weeks or more in a row that doing some usual activities was impossible   (Yes/No)
* *attempted_suicide*:   during the past 12 months, actually attempt suicide   (Yes/No)
* *injurious_suicide_attempt*:   attempted suicide, during the past 12 months, resulted in an injury, poisoning, or overdose that had to be treated by a doctor or nurse   (Yes/No)
* *considered_suicide*:   during the past 12 months, seriously considered attempting suicide   (Yes/No)


**Risky Behaviors/Violence**

* *safety_concerns_at_school*:  subject did not went to school due to feeling unsafe at school or on way to or from school during the past 30 days   (Yes/No)
* *threatened_at_school*:  subject has been threatened or injured with a weapon such as a gun, knife, or club on school property during the past 12 months   (Yes/No)
* *physical_fighting*:   subject has been in a physical fight during the past 12 months   (Yes/No)
* *bullying_at_school*:   subject has been bullied on school property during the past 12 months   (Yes/No)
* *bullying_electronically*:   subject has been bullied electronically (i.e. facebook) during the past 12 months   (Yes/No)
* *illegal_injected_drug_use*: subject has used needle to inject any illegal drug into body during life time   (Yes/No)
* *carring_weapon*:   subject carried a weapon such as a gun, knife, or club during the past 30 days   (Yes/No)
* *sex_before_13*:   subject had first sexual intercourse before age 13   (Yes/No)
* *current_sexual_activity*: subject had sexual intercourse with 1 or more people during the past 3 months   (Yes/No)


<br> <br>






# Explorary Analysis

<br>


```{r load_the_cleaned_data}
### load the cleaned data
load("./data/nyc_data.RData")
nyc_drug <- df_total

```

## Vaping & other drug use 

Animated graphs show the distributions of vaping and other drug use. 

```{r distribution_vaping_other_drugs}
## filter the data used in this part
nyc_drug_used <- nyc_drug %>% 
  select(id, borough, year, 
         cigarette = current_cigarette_use, cigar = current_cigar_use,
         alcohol = current_alcohol_use, marijuana = current_marijuana_use,
         vaping = current_vaping) %>% 
  mutate(year = factor(year))

## cigarette proportion
cigarette <- nyc_drug_used %>% 
  filter(!is.na(cigarette)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            cigarette = sum(cigarette == "Yes")/n) %>% 
  select(-n)

## cigar proportion
cigar <- nyc_drug_used %>% 
  filter(!is.na(cigar)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            cigar = sum(cigar == "Yes")/n) %>% 
  select(-n) 

## alcohol proportion
alcohol <- nyc_drug_used %>% 
  filter(!is.na(alcohol)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            alcohol = sum(alcohol == "Yes")/n) %>% 
  select(-n) 


## vaping proportion 
vaping <- nyc_drug_used %>% 
  filter(!is.na(vaping)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            vaping = sum(vaping == "Yes")/n) %>% 
  select(-n) 

## marijuana proportion with all other proportions
marijuana_full <- nyc_drug_used %>% 
  filter(!is.na(marijuana)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            marijuana = sum(marijuana == "Yes")/n) %>% 
  select(-n) %>% 
  left_join(cigarette, by = c("year", "borough")) %>% 
  left_join(cigar, by = c("year", "borough")) %>% 
  left_join(alcohol, by = c("year", "borough")) %>% 
  left_join(vaping, by = c("year", "borough")) %>% 
  pivot_longer(marijuana:vaping,
               names_to = "drug_type",
               values_to = "proportion")

drug_p <- marijuana_full %>%
  filter(!(is.na(proportion)))%>%
  ggplot(aes(x = year, y = proportion, color = borough, shape = drug_type, 
             group = interaction(borough, drug_type), frame = drug_type)) +
  geom_point(size = 2.2) + geom_path(size = .8) +
  labs(title = "{closest_state}",
       x = "Year",
       y = "Proportion of drug use",
       color = "Borough",
       shape = "Drug type") +
  theme(plot.title = element_text(size = 30, face = "bold"),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15,face = "bold")) + 
  theme(legend.text = element_text(size = 10), legend.title = element_text(size = 15, face = "bold")) +  
  transition_states(drug_type, transition_length = 1, state_length = 3, wrap = TRUE) +
  enter_fade() + exit_fade()

animate(drug_p)
```

* Among five kinds of drugs(vaping), alcohol holds the highest proportion but decreases in use from 2007 across five boroughs in NYC. In addition, cigarette has a lower total proportion than alcohol but the similar decreasing trend after 2009. 

* Cigar maintains the steady but low-proportion trend during 2003-2017, which could be compared with marijuana holding steady but higher proportion in total. Moreover, the marijuana users in Manhattan increase from the lowest level to highest level among five boroughs during 2007-2011. 

* Vaping, which is our target subject, hold the increasing trend from 2015-2017. This trend is quite similar to the alcohol, cigar and cigarette before being intervented, and maintains at the same proportion level with marijuana in 2015-2017, which indicates that it can grow into a new drug threatening the public health.

## Mental health 

Animated graphs show the distributions of mental health problems which are related to vaping. 

```{r distribution_mental_health}
## data for mental health disorder
nyc_drug_health <- nyc_drug %>% 
  select(id, year, borough, sad = sad_hopeless, 
         suicide = attempted_suicide, injury = injurious_suicide_attempt) %>% 
  mutate(year = factor(year))

## sadless
sad <- nyc_drug_health %>% 
  filter(!is.na(sad)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            sad = sum(sad == "Yes")/n) %>% 
  select(-n)

## attempted suicide
suicide <- nyc_drug_health %>% 
  filter(!is.na(suicide)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            suicide = sum(suicide == "Yes")/n) %>% 
  select(-n)

## injurious attempted suicide
injury_full <- nyc_drug_health %>% 
  filter(!is.na(injury)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            injury = sum(injury == "Yes")/n) %>% 
  select(-n) %>% 
  left_join(sad, by = c("year", "borough")) %>% 
  left_join(suicide, by = c("year", "borough")) %>% 
  pivot_longer(injury:suicide,
               names_to = "mental_disorder",
               values_to = "proportion")

## animated plot
mental_p <- injury_full %>%
  filter(!(is.na(proportion))) %>% 
  ggplot(aes(x = year, y = proportion, color = borough, shape = mental_disorder, 
             group = interaction(borough, mental_disorder))) +
  geom_point(size = 2.2) + geom_path(size = .8) +
  labs(x = "Year",
       y = "Proportion of mental disorder",
       color = "Borough",
       shape = "Mental disorder") +  
  scale_shape_discrete(labels = c("injurious attempted suicide", "sad and hopeless", "attempted suicide")) +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15,face = "bold")) + 
  theme(legend.text = element_text(size = 10), legend.title = element_text(size = 15, face = "bold"))  +
  transition_states(mental_disorder, transition_length = 1, state_length = 3, wrap = TRUE) +
  enter_fade() + exit_fade()

animate(mental_p)

```

* Above three mental disorders are related to the vaping and other drug use in the report/survey. The emotion issue, feeling sad and hopeless, hold the highest level among three metal disorders. The data shows large number of teenagers do not have a positive mood based on the participants attending the report, and the trend decreases slightly after 2009. Staten Island keeps the lowest proportion in the reported sadness except 2011. Bronx almost keeps the highest level and Queens fluctuates heavily which decreases a lot during 2005 to 2011. 

* The proportion of attempted suicide holds the level near 0.1 and is higher than that of getting injured due to the attempted suicide. Both of attempted suicide and injurious attempted suicide keep the relative steady trend in proportion and the same level across five boroughs. 

## Violence and other risky behaviors

We are interested in whether violence and risky behaviors have difference profiles than other drug use.

```{r drug_with_violence_risky_behaviors}
## drugs with violence
nyc_drug_violence <- nyc_drug %>% 
  select(id, borough, year, 
         cigarette = current_cigarette_use, cigar = current_cigar_use,
         alcohol = current_alcohol_use, marijuana = current_marijuana_use,
         vaping = current_vaping, safety_concerns_at_school, threatened_at_school,  
         physical_fighting, bullying_at_school, bullying_electronically, 
         carring_weapon) %>% 
  mutate(year = factor(year))

## cigaretteYes
cigarette_yes <- nyc_drug_violence %>% 
  filter(cigarette == "Yes") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, carring_weapon, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            cigarette = sum(reply == "Yes")/n) %>% 
 select(-n)

## cigarYes
cigar_yes <- nyc_drug_violence %>% 
  filter(cigar == "Yes") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, carring_weapon, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            cigar = sum(reply == "Yes")/n) %>% 
  select(-n)

## alcoholYes
alcohol_yes <- nyc_drug_violence %>% 
  filter(alcohol == "Yes") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, carring_weapon, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            alcohol = sum(reply == "Yes")/n) %>% 
  select(-n)

## vapingYes
vaping_yes <- nyc_drug_violence %>% 
  filter(vaping == "Yes") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, carring_weapon, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            vaping = sum(reply == "Yes")/n) %>% 
  select(-n)

## marijuanaYes with all other drugs
marijuana_yes_full <- nyc_drug_violence %>% 
  filter(marijuana == "Yes") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, carring_weapon, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            marijuana = sum(reply == "Yes")/n) %>% 
  select(-n) %>% 
  left_join(cigarette_yes, by = c("year", "violence")) %>% 
  left_join(cigar_yes, by = c("year", "violence")) %>% 
  left_join(alcohol_yes, by = c("year", "violence")) %>% 
  left_join(vaping_yes, by = c("year", "violence")) %>% 
  gather(key = "drug", value = "proportion", 
         marijuana, cigarette, cigar, alcohol, vaping)


## animated plot
violence_p <- marijuana_yes_full %>%
  ggplot(aes(x = drug, y = proportion, fill = violence, group = violence)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Teenagers using drugs in {closest_state}",
       x = "Drug Type",
       y = "Proportion of happening violence",
       fill = "Violence Type") +
  theme(plot.title = element_text(size = 20, face = "bold"),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15,face = "bold")) + 
  theme(legend.position = "none") +
  transition_states(year, transition_length = 2, state_length = 3) +
  enter_fade() + exit_shrink()

yes_p <- animate(violence_p, fps = 2, width = 480, height = 350)


# Plot under non-use of drug
## cigaretteNo
cigarette_no <- nyc_drug_violence %>% 
  filter(cigarette == "No") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, carring_weapon, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            cigarette = sum(reply == "Yes")/n) %>% 
 select(-n)

## cigarNo
cigar_no <- nyc_drug_violence %>% 
  filter(cigar == "No") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, carring_weapon, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            cigar = sum(reply == "Yes")/n) %>% 
  select(-n)

## alcoholNo
alcohol_no <- nyc_drug_violence %>% 
  filter(alcohol == "No") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, carring_weapon, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            alcohol = sum(reply == "Yes")/n) %>% 
  select(-n)

## vapingNo
vaping_no <- nyc_drug_violence %>% 
  filter(vaping == "No") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, carring_weapon, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            vaping = sum(reply == "Yes")/n) %>% 
  select(-n)

## marijuanaYes with all other drugs
marijuana_no_full <- nyc_drug_violence %>% 
  filter(marijuana == "No") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, carring_weapon, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            marijuana = sum(reply == "Yes")/n) %>% 
  select(-n) %>% 
  left_join(cigarette_no, by = c("year", "violence")) %>% 
  left_join(cigar_no, by = c("year", "violence")) %>% 
  left_join(alcohol_no, by = c("year", "violence")) %>% 
  left_join(vaping_no, by = c("year", "violence")) %>% 
  gather(key = "drug", value = "proportion", 
         marijuana, cigarette, cigar, alcohol, vaping)


## animated plot
violence_no_p <- marijuana_no_full %>%
  ggplot(aes(x = drug, y = proportion, fill = violence, group = violence)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Teenagers not using drugs in {closest_state}",
       x = "Drug Type",
       y = "Proportion of happening violence",
       fill = "Violence Type") +
  scale_fill_discrete(labels = c("Bullying at school", "Bullying electronically",
                                 "Carrying weapons","Physical fighting", 
                                 "Safely concerns at school", "Threatened at school")) +
  theme(plot.title = element_text(size = 20, face = "bold"),
        axis.text = element_text(size = 15),
        axis.title = element_text(size = 15,face = "bold")) + 
  theme(legend.text = element_text(size = 10), legend.title = element_text(size = 15, face = "bold")) +
  transition_states(year, transition_length = 2, state_length = 3) +
  enter_fade() + exit_shrink()

no_p <- animate(violence_no_p, fps = 2, width = 620, height = 350)

combine_gifs <- function(plot1, plot2) {
    require(magick) 
    # read the plots and store them
    plot1 <- image_read(plot1) 
    plot2 <- image_read(plot2) 
    # sync the number of frames in each plot
    n1 = length(plot1)
    n2 = length(plot2)
    # match number of frames of the two plots
    if (!(n1 == n2)) plot1 <- rep(plot1, n2) 
    if (!(n1 == n2)) plot2 <- rep(plot2, n1)
    # initialize the combined plot
    p <- image_append(c(plot1[1], plot2[1]))
    # grow the combined plot frame by frame
    n = ifelse(n1 == n2, n1, n1 * n2) 
    n = min(1000, n)  # set max to 1000
    for (i in 2:(n-1)) {
        tmp <- image_append(c(plot1[i], plot2[i]))
        p <- c(p, tmp)
    }
    return(p) 
}

combine_gifs(plot1 = yes_p, plot2 = no_p)

```

* The left plot has the twice value than the right plot when the bar is in the same height. Therefore, the proportion of having violence nad risky behaviors in the teenagers who use drugs is nearly twice than the that in the teenagers who are non-drug users. Moreover, non-drug users have lower proportion in carrying weapons from 2003 to 2017. 

* Physical fighting, feeling unsafe at school and being treantened at school increase in proportion during 2005-2007, keep the same proportion in 2009,  and begin to decrease in 2011. 

* Physical fighting keeps high proportion in both drug users and non-drug users and becomes a issue which is hard to control and intervent in 2003-2017. 

* Bullying electronically is another issue whose proportion inceases from 2015 to 2017 in both two groups







<br> <br>

# Logistic Regression Model

<br>


Since we were investigating the prevelance and trend in vaping among NYC's youth, we were interested in predicting **current_vaping**. We began our model building process considering the following predictors:

**Demographics**

* *borough*:   one of the five boroughs of NYC
* *age*:   age of the subject
* *sex*:   gender of the subject (male, female)
* *race7*:   race of the subject

**Mental Health**

* *sad_hopeless*:   during the past 12 months, felt so sad or hopeless almost every day for two weeks or more in a row that doing some usual activities was impossible   (Yes/No)
* *attempted_suicide*:   during the past 12 months, actually attempt suicide   (Yes/No)
* *injurious_suicide_attempt*:   attempted suicide, during the past 12 months, resulted in an injury, poisoning, or overdose that had to be treated by a doctor or nurse   (Yes/No)
* *considered_suicide*:   during the past 12 months, seriously considered attempting suicide   (Yes/No)


**Risky Behaviors/Violence**

* *safety_concerns_at_school*:  subject did not went to school due to feeling unsafe at school or on way to or from school during the past 30 days   (Yes/No)
* *threatened_at_school*:  subject has been threatened or injured with a weapon such as a gun, knife, or club on school property during the past 12 months   (Yes/No)
* *physical_fighting*:   subject has been in a physical fight during the past 12 months   (Yes/No)
* *bullying_at_school*:   subject has been bullied on school property during the past 12 months   (Yes/No)
* *bullying_electronically*:   subject has been bullied electronically (i.e. facebook) during the past 12 months   (Yes/No)
* *illegal_injected_drug_use*: subject has used needle to inject any illegal drug into body during life time   (Yes/No)
* *carring_weapon*:   subject carried a weapon such as a gun, knife, or club during the past 30 days   (Yes/No)
* *sex_before_13*:   subject had first sexual intercourse before age 13   (Yes/No)
* *current_sexual_activity*: subject had sexual intercourse with 1 or more people during the past 3 months   (Yes/No)

<br> <br>

## Manuel Method

<br>

First, we attempted to find a predictive model by using a variation on **stepwise/automatic procedures** (by hand). We utilized p-values and prediction accuracy as our guidance for which predictors to choose, starting with the full model. 


```{r Manuel_Method, eval = FALSE}
# Fitting a logistic regression model
fit_logistic = glm(current_vaping ~ sad_hopeless  + attempted_suicide + safety_concerns_at_school + illegal_injected_drug_use + physical_fighting + bullying_electronically + carring_weapon + sex_before_13 , data = df, family = binomial(),na.action = na.omit)

# Looking at the model coefficients
fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  knitr::kable(digits = 3)
```

```{r Model_Criteria, eval = FALSE}
# What is the contribution of each predictor? see: https://uc-r.github.io/logistic_regression#multi
caret::varImp(fit_logistic)

# Cross-Validating the model
data_train <- trainControl(method = "cv", number = 5)

model_caret <- train(
  current_vaping ~ sad_hopeless  + attempted_suicide + safety_concerns_at_school + threatened_at_school + physical_fighting + bullying_electronically + carring_weapon,
                   data = df,
                   trControl = data_train,
                   method = 'glm',
                   family = binomial(),
                   na.action = na.pass)
  
model_caret
AIC(fit_logistic)


fit_logistic$formula
```

In the end, this process came up with the following possible model:

<br>

**Model 1**

current_vaping ~ sad_hopeless + attempted_suicide + safety_concerns_at_school + illegal_injected_drug_use + physical_fighting + bullying_electronically + carring_weapon + sex_before_13

<br> <br>


## Step AIC Model

<br>

Considering the large number of predictor candidates in our model, we decided to take advantage of modern computational power and use the stepwise regression method to come up with a model. 
The criteria we used is AIC, a goodness of fit measure that helps to avoid overfitting. It also circumvents the big p value problem introduced by our potentially highly correlated predictor candidates.
The actual function used is the StepAIC function from the MASS package.

```{r eval = FALSE}

###Defining a glm object that contains the regression model generated
auto_logistic = glm(
  ###Fixing "current_vaping" as response,whith all the vairble candidtates as pridictors.
  current_vaping ~., data = df, 
  ###Runing logistics regression, with complete analysis
  family = binomial(),na.action = na.omit) %>%
  ###Choose a model by AIC in a Stepwise Algorithm
  MASS::stepAIC(trace = FALSE)

AIC(auto_logistic)

auto_logistic %>% broom::tidy()
auto_logistic$formula
```


The formula generated by the function is as follows:


**Model 2**

current_vaping ~ carring_weapon + sad_hopeless + attempted_suicide + 
   safety_concerns_at_school + physical_fighting + bullying_electronically + 
    age + race7 + illegal_injected_drug_use + sexual_contact_2






## LASSO

<br>

The motivation behind using the LASSO method is that we have a lot of potential predictors available and we cannot (and do not want to) to do an exhaustive search manually. LASSO is a shinkage method that avoids overfitting and help with variable selection. These advantages make LASSO one of the most popular methods in regression problem settings. In our study we chose the penalty paramter lamda based on the cross-validation error. Then we used the optimal lamda to rerun the LASSO again to get our final model.

```{r eval = FALSE}
###Defining a glmnet object that contains the cv lasso model generated to find the best lambda to use
  lasso_temp = cv.glmnet(
  ###Fixing "current_vaping" as response,whith all the vairble candidtates as pridictors.
    current_vaping ~., data = df, 
    ###Runing for logistics outcom
    family = "binomial")

###Defining a glmnet object that contains the final lasso model using the best lambda generated
  lasso_logistic = glmnet(
  ###Fixing "current_vaping" as response,whith all the vairble candidtates as pridictors.
    current_vaping ~., data = df, 
    ###Runing for logistics outcom
    family = "binomial",
    ### With the best lambda
    lambda = lasso_temp$lambda.min
    )
```

In the end the final model from LASSO is the following:

Model 3: current_vaping ~ age + sex + race7 + sad_hopeless + attempted_suicide + injurious_suicide_attempt + safety_concerns_at_school + physical_fighting + bullying_electronically + illegal_injected_drug_use + carring_weapon + sex_before_13 + current_sexual_activity

The LASSO model has tunning paramter lamda equals 0.005 and the model contains more covariates than the above two models since LASSO putting shringkage on the coefficient of each covariate and thus will include more covariates (remember that LASSO will automatically do the variable selection).





<br>



## Model Selection 

### Picking the "best" Model

At this point we had three predictive models. In order to decide which of them is the "best", we employed  cross-validation prediction accuracy as our criteria. The prediction accuracy is calculated as the proportion of correct prediction made by the model.

To perform the cross-validation in a compact and well-integrated manner, we coded our model selection process as robust functions that can be mapped to a modlr cv object by purrr to streamline the cross-validation process.
We conducted a 5 fold 10 times CV on the three models.


```{r }
## function for stepAIC method
log_reg_auto = function(cv_df){
  cv_df %>% mutate(
###Automodel selection with AIC as criterial
         automodel  = map(train, ~glm(current_vaping ~., data = .x, family = binomial(),na.action = na.exclude)%>%MASS::stepAIC(trace = FALSE))
 ) }

###function for lasso selection method
lasso = function(df){
  lasso_temp = cv.glmnet(current_vaping ~., data = df, family = "binomial")
glmnet(current_vaping ~., data = df, family = "binomial",lambda = lasso_temp$lambda.min)
}
### formular for manual selection
manual_formular = current_vaping ~ sad_hopeless + attempted_suicide + safety_concerns_at_school + 
    threatened_at_school + physical_fighting + bullying_electronically + 
    carring_weapon

###find prediction accuracy
accy = function(model,data){
  Temp = predict(model, data, type = "response") %>% round()
1 - mean(Temp - (as.numeric(pull(as.tibble(data),current_vaping)) - 1))
}
```

```{r include=FALSE}

load("./data/nyc_data.RData")

# Creating the dataset we will use to build the model
df = df_total %>% 
  ### Select only the vairbale candidates from the data set 
  select(
    # binary respone
    current_vaping,
    # possible predictor
    borough,
    year,
    age,
    sex,
    race7,
    sad_hopeless,
    attempted_suicide,
    injurious_suicide_attempt,
    considered_suicide,
    safety_concerns_at_school,
    threatened_at_school,
    physical_fighting,
    bullying_at_school,
    bullying_electronically,
  illegal_injected_drug_use,
    carring_weapon,
    sex_before_13,
    current_sexual_activity)


df15 = df %>% filter(year == 2015) %>% 
  ###Wanna do complete analysis
  drop_na()

df17 = df %>% filter(year == 2017) %>% 
  ###Wanna do complete analysis
  drop_na()

```



```{r eval=FALSE}
cv_df=
  ## Making the CV_df by modelr, for 5 folds and 10 times.
  crossv_mc(df15,n=10)


cv_df = cv_df%>%
##stepAIC
  log_reg_auto()%>%
  ## Manual model
  mutate(manual_model = map(train, ~glm(manual_formular, data = .x, family = binomial,na.action = na.exclude)))%>%
  ## Lasso model
 mutate(lasso_model = map(train,~lasso(.x)))

###Prediction Accuracy computation
cv_df = cv_df%>%
  mutate(
        accuracy_automodel= map2_dbl(.x = automodel,.y = test, ~accy(data =.y,model =.x)),
        accuracy_manualmodel= map2_dbl(.x = manual_model,.y = test, ~accy(data =.y,model =.x)),
        accuracy_lasso= map2_dbl(.x = lasso_model,.y = test, ~accy(data =.y,model =.x))
        )


###Graph accuracy distribution
cv_df%>%select(starts_with("accuracy")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "Accuracy",
    names_prefix = "accuracy_") %>% 
  mutate(Models = recode(model,automodel = "StepAIC Model",manualmodel = "Manual Model", lasso = "Lasso Model"))%>%
  ggplot(aes(x = Models, y = Accuracy)) + geom_violin()
```


<left><img src = "Logistic_Regression_Model_Selection_files/figure-html/CrossValidation-1.png" style = "width:60%"> </left>


According to the violin plot, which shows the distribution of prediction accuracy, the model that was generated by stepAIC (StepAIC model) has an accuracy about 1% better than the accuracy of the model generated by lasso (Lasso model) and an accuracy about  and 2% better than the one from the manual selection (Manual model) method. Therefore, we picked the stepAIC model as our finial model.



### Model applied to 2017 Data

Subsequently, we used all three models to predict the vaping status of teenagers in 2017. As can be seen in the table below, the StepAIC model also performed best among the three models considered, giving a more than 87% accuracy rate. 


```{r }
## The model generated using the full data set is recreated
Final_model =
  ## tibble
  tibble(train = list(df15),
         test = list(df17)) %>%
  ##stepAIC
  log_reg_auto() %>%
  ## Manual model
  mutate(manualmodel = map(train, ~glm(manual_formular, data = .x, family = binomial,na.action = na.exclude))) %>%
  ## Lasso model
  mutate(lassomodel = map(train,~lasso(.x)))
```

```{r }
Final_model %>%
  mutate(
        accuracy_automodel = map2_dbl(.x = automodel,.y = test, ~accy(data =.y,model =.x)),
        accuracy_manualmodel = map2_dbl(.x = manualmodel,.y = test, ~accy(data =.y,model =.x)),
        accuracy_lasso = map2_dbl(.x = lassomodel,.y = test, ~accy(data =.y,model =.x))
        ) %>%
  select("Accuracy StepAIC Model"=accuracy_automodel, "Accuracy Manual Model" = accuracy_manualmodel, "Accuracy Lasso Model"= accuracy_lasso) %>% round(digits = 3) %>% knitr::kable(caption = "Prediction Accuray by Model on 2017 data")
```


In conclusion, the final logistic regression model (StepAIC model) has the following formulae:

**current_vaping ~ carring_weapon + sad_hopeless + attempted_suicide + safety_concerns_at_school + physical_fighting + bullying_electronically + age + race7 + illegal_injected_drug_use + sexual_contact_2**

<br><br>


# Discussion

<br>