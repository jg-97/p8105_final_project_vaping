---
title: "Report"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: journal
---
Author: Jin Ge

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      fig.height = 5,
                      fig.width = 9)
library(tidyverse)
library(gganimate)
library(transformr)
library(readxl)
library(gifski)
library(magick)
theme_set(theme_bw())
```

# Motivation

### Facts about vaping

* 2,051 reported lung illness cases and 39 lung illness deaths due to vaping.

* 81% Americans report teenagers who would not smoke cigarettes are using flavored e-cigarettes

* Most popular e-cigarette product introduces with a 5% nicotine up to 2.7 times delievering nicotine than others

According to reports in recent years, we can see an underlying trend of vaping is increasing, especially in the teenager group.

### Data introduction

In order to use the data conveniently, we clean and tidy the data at the beginning, and yield file containing the data.

* sex: male, female, other(i.e.transgender)
* borough: five boroughs in the New York City
* sad_hopeless: feeling so sad or hopeless almost every day for two weeks or more
* attempted_suicide: ever attempted to do suicide
* injurious_suicide_attempt: attempted suicides result in an injury, poisoning, or overdose that had to be treated by a doctor or nurse
* current_cigarette_use: smoked cigarettes during the past 30 days
* current_vaping: used an electronic vapor product during the past 30 days
* current_cigar_use: smoked cigars, cigarillos, or little cigars during the past 30 days
* current_alcohol_use: had at least one drink of alcohol
* current_marijuana_use: used marijuana during the past 30 days


# Questions

According to the existing defined drugs, such as traditional tobacco use, alcohol, and the recent reported facts about vaping, we want to find answers to the following questions:

* Whether the distribution of vaping has been similar with other drugs? What will the trend look like? 
* Whether the mental health reported in company with the vaping has an association?
* What are drugs decomposed by demographics and year?
* Are there an association between licenses for selling e-cigarettes and e-cigarette usage by borough over year?
* Can the vaping be decomposed by experienced violenced and other risky behaviors?


# Explorary Analysis

We will give the analysis and visualization accorded with the questions

```{r load_the_cleaned_data}
### load the cleaned data
load("./data/nyc_data.RData")
nyc_drug <- df_total
#### A better way to do it by avoiding uneeded format transformation_byHS
```

## Distribution of vaping and existing drug use over time by borough

We plot an animated graph to show the distribution of vaping and defined drug use. each drug will exist in an order corresponding to the legend.

```{r distribution_vaping_other_drugs}
## filter the data used in this part
nyc_drug_used <- nyc_drug %>% 
  select(id, borough, year, 
         cigarette = current_cigarette_use, cigar = current_cigar_use,
         alcohol = current_alcohol_use, marijuana = current_marijuana_use,
         vaping = current_vaping) %>% 
  mutate(year = factor(year))

## cigarette proportion
cigarette <- nyc_drug_used %>% 
  filter(!is.na(cigarette)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            cigarette = sum(cigarette == "Yes")/n) %>% 
  select(-n)

## cigar proportion
cigar <- nyc_drug_used %>% 
  filter(!is.na(cigar)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            cigar = sum(cigar == "Yes")/n) %>% 
  select(-n) 

## alcohol proportion
alcohol <- nyc_drug_used %>% 
  filter(!is.na(alcohol)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            alcohol = sum(alcohol == "Yes")/n) %>% 
  select(-n) 


## vaping proportion 
vaping <- nyc_drug_used %>% 
  filter(!is.na(vaping)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            vaping = sum(vaping == "Yes")/n) %>% 
  select(-n) 

## marijuana proportion with all other proportions
marijuana_full <- nyc_drug_used %>% 
  filter(!is.na(marijuana)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            marijuana = sum(marijuana == "Yes")/n) %>% 
  select(-n) %>% 
  left_join(cigarette, by = c("year", "borough")) %>% 
  left_join(cigar, by = c("year", "borough")) %>% 
  left_join(alcohol, by = c("year", "borough")) %>% 
  left_join(vaping, by = c("year", "borough")) %>% 
  pivot_longer(marijuana:vaping,
               names_to = "drug_type",
               values_to = "proportion")

drug_p <- marijuana_full %>%
  filter(!(is.na(proportion)))%>%
  ggplot(aes(x = year, y = proportion, color = borough, shape = drug_type, 
             group = interaction(borough, drug_type), frame = drug_type)) +
  geom_point(size = 2.2) + geom_path(size = .8) +
  labs(title = "{closest_state}",
       x = "Year",
       y = "Proportion of drug use",
       color = "Borough",
       shape = "Drug type") +
  theme(plot.title = element_text(size = 30, face = "bold"),
        axis.text=element_text(size = 15),
        axis.title=element_text(size = 15,face = "bold")) + 
  theme(legend.text=element_text(size = 10), legend.title=element_text(size = 15, face = "bold")) +  
  transition_states(drug_type, transition_length = 1, state_length = 3, wrap = TRUE) +
  enter_fade() + exit_fade()

animate(drug_p)
```


## Distribution of mental health over time by borough

We plot an animated graph to show the distribution of some mental disorders which are related to the vaping according to the recent reports. each kind of disorder will exist in an order corresponding to the legend.

```{r distribution_mental_health}

nyc_drug_health <- nyc_drug %>% 
  select(id, year, borough, sad = sad_hopeless, 
         suicide = attempted_suicide, injury = injurious_suicide_attempt) %>% 
  mutate(year = factor(year))

sad <- nyc_drug_health %>% 
  filter(!is.na(sad)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            sad = sum(sad == "Yes")/n) %>% 
  select(-n)

suicide <- nyc_drug_health %>% 
  filter(!is.na(suicide)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            suicide = sum(suicide == "Yes")/n) %>% 
  select(-n)

injury_full <- nyc_drug_health %>% 
  filter(!is.na(injury)) %>% 
  group_by(year, borough) %>% 
  summarize(n = n(),
            injury = sum(injury == "Yes")/n) %>% 
  select(-n) %>% 
  left_join(sad, by = c("year", "borough")) %>% 
  left_join(suicide, by = c("year", "borough")) %>% 
  pivot_longer(injury:suicide,
               names_to = "mental_disorder",
               values_to = "proportion")

mental_p <- injury_full %>%
  filter(!(is.na(proportion))) %>% 
  ggplot(aes(x = year, y = proportion, color = borough, shape = mental_disorder, 
             group = interaction(borough, mental_disorder))) +
  geom_point(size = 2.2) + geom_path(size = .8) +
  labs(x = "Year",
       y = "Proportion of mental disorder",
       color = "Borough",
       shape = "Mental disorder") +  
  scale_shape_discrete(labels = c("injurious attempted suicide", "sad and hopeless", "attempted suicide")) +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15,face = "bold")) + 
  theme(legend.text = element_text(size = 10), legend.title = element_text(size = 15, face = "bold"))  +
  transition_states(mental_disorder, transition_length = 1, state_length = 3, wrap = TRUE) +
  enter_fade() + exit_fade()

animate(mental_p)

```


## Association between licenses for selling e-cigarettes and e-cigarette usage by borough over year

## Drugs(vaping) decomposed by experienced violenced and other risky behaviors

We are interested in whether there will be something worth being examined if we decompose the drug by the experienced violenced behaviors 

```{r drug_with_violence}
## drugs with violence
nyc_drug_violence <- nyc_drug %>% 
  select(id, borough, year, 
         cigarette = current_cigarette_use, cigar = current_cigar_use,
         alcohol = current_alcohol_use, marijuana = current_marijuana_use,
         vaping = current_vaping, safety_concerns_at_school, threatened_at_school,
         physical_fighting, bullying_at_school, bullying_electronically) %>% 
  mutate(year = factor(year))

## cigaretteYes
cigarette_yes <- nyc_drug_violence %>% 
  filter(cigarette == "Yes") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            cigarette = sum(reply == "Yes")/n) %>% 
  select(-n)

## cigarYes
cigar_yes <- nyc_drug_violence %>% 
  filter(cigar == "Yes") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            cigar = sum(reply == "Yes")/n) %>% 
  select(-n)

## alcoholYes
alcohol_yes <- nyc_drug_violence %>% 
  filter(alcohol == "Yes") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            alcohol = sum(reply == "Yes")/n) %>% 
  select(-n)

## vapingYes
vaping_yes <- nyc_drug_violence %>% 
  filter(vaping == "Yes") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            vaping = sum(reply == "Yes")/n) %>% 
  select(-n)

## marijuanaYes with all other drugs
marijuana_yes_full <- nyc_drug_violence %>% 
  filter(marijuana == "Yes") %>% 
  gather(key = "violence", value = "reply", safety_concerns_at_school, 
         threatened_at_school, physical_fighting, bullying_at_school, 
         bullying_electronically, na.rm = TRUE) %>% 
  group_by(year, violence) %>% 
  summarize(n = n(),
            marijuana = sum(reply == "Yes")/n) %>% 
  select(-n) %>% 
  left_join(cigarette_yes, by = c("year", "violence")) %>% 
  left_join(cigar_yes, by = c("year", "violence")) %>% 
  left_join(alcohol_yes, by = c("year", "violence")) %>% 
  left_join(vaping_yes, by = c("year", "violence")) %>% 
  gather(key = "drug", value = "proportion", 
         marijuana, cigarette, cigar, alcohol, vaping)

## animated plot
violence_p <- marijuana_yes_full %>%
  ggplot(aes(x = drug, y = proportion, fill = violence, group = violence)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Year: {closest_state}",
       x = "Drug Type",
       y = "Proportion of happening violence",
       fill = "Violence Type") +
  scale_fill_discrete(labels = c("Bullying in school", "Bullying electronically",
                                 "Physical fighting", "Safely concerns at school",
                                 "Threatened at school")) +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15,face = "bold")) + 
  theme(legend.text = element_text(size = 10), legend.title = element_text(size = 15, face = "bold")) +
  transition_states(year, transition_length = 2, state_length = 3) +
  enter_fade() + exit_shrink()
  
animate(violence_p)
```

We are also interested in whether there will be something worth being examined if we decompose the drug by risky behaviors

```{r drug_with_risky_behavior}

## drugs with risky behavior
nyc_drug_risk <- nyc_drug %>% 
  select(id, borough, year, 
         cigarette = current_cigarette_use, cigar = current_cigar_use,
         alcohol = current_alcohol_use, marijuana = current_marijuana_use,
         vaping = current_vaping, texting_and_driving, drinking_and_driving) %>% 
  mutate(year = factor(year))

## cigaretteYes
cigarette_yes_risk <- nyc_drug_risk %>% 
  filter(cigarette == "Yes") %>% 
  gather(key = "risk", value = "reply", 
         texting_and_driving, drinking_and_driving, na.rm = TRUE) %>% 
  group_by(year, risk) %>% 
  summarize(n = n(),
            cigarette = sum(reply == "Yes")/n) %>% 
  select(-n)

## cigarYes
cigar_yes_risk <- nyc_drug_risk %>% 
  filter(cigar == "Yes") %>% 
  gather(key = "risk", value = "reply", 
         texting_and_driving, drinking_and_driving, na.rm = TRUE) %>% 
  group_by(year, risk) %>% 
  summarize(n = n(),
            cigar = sum(reply == "Yes")/n) %>% 
  select(-n)

## alcoholYes
alcohol_yes_risk <- nyc_drug_risk %>% 
  filter(alcohol == "Yes") %>% 
  gather(key = "risk", value = "reply", 
         texting_and_driving, drinking_and_driving, na.rm = TRUE) %>% 
  group_by(year, risk) %>% 
  summarize(n = n(),
            alcohol = sum(reply == "Yes")/n) %>% 
  select(-n)

## vapingYes
vaping_yes_risk <- nyc_drug_risk %>% 
  filter(vaping == "Yes") %>% 
  gather(key = "risk", value = "reply", 
         texting_and_driving, drinking_and_driving, na.rm = TRUE) %>% 
  group_by(year, risk) %>% 
  summarize(n = n(),
            vaping = sum(reply == "Yes")/n) %>% 
  select(-n)

## marijuanaYes with all other drugs
marijuana_yes_risk_full <- nyc_drug_risk %>% 
  filter(marijuana == "Yes") %>% 
  gather(key = "risk", value = "reply", 
         texting_and_driving, drinking_and_driving, na.rm = TRUE) %>% 
  group_by(year, risk) %>% 
  summarize(n = n(),
            marijuana = sum(reply == "Yes")/n) %>% 
  select(-n) %>% 
  left_join(cigarette_yes_risk, by = c("year", "risk")) %>% 
  left_join(cigar_yes_risk, by = c("year", "risk")) %>% 
  left_join(alcohol_yes_risk, by = c("year", "risk")) %>% 
  left_join(vaping_yes_risk, by = c("year", "risk")) %>% 
  gather(key = "drug", value = "proportion", 
         marijuana, cigarette, cigar, alcohol, vaping)

## animated plot
risk_p <- marijuana_yes_risk_full %>%
  ggplot(aes(x = drug, y = proportion, fill = risk, group = risk)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Year: {closest_state}",
       x = "Drug Type",
       y = "Proportion of happening risky behaviors",
       fill = "Risky behavior Type") +
  scale_fill_discrete(labels = c("Drinking and Driving", "Texting and Driving")) +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15,face = "bold")) + 
  theme(legend.text = element_text(size = 10), legend.title = element_text(size = 15, face = "bold")) +
  transition_states(year, transition_length = 2, state_length = 3) +
  enter_fade() + exit_shrink()
  
animate(risk_p)

```

## Logistic regression model to do prediction of the vaping trend


# Conclusion

# Discussion