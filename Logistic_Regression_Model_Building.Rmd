---
title: "Logistic Regression: Model Building"
author: "Daniela Quigee (dq2147)"
date: "12/3/2019"
output: html_document
---

```{r setup, include = FALSE}
library(tidyverse)
library(modelr)
library(caret)
library(pscl)
library(glmnet)
library(gmodels)
###This package provide glm like interface for glmnet
library(glmnetUtils)

```


```{r Data Import}
# Loading the cleaned data
load("./data/nyc_data.RData")
```


```{r Data_frame_for_Prediction_Model}
# Creating the dataset we will use to build the model
df = df_total %>% 
  ### Select only possible candidates from the data set 
  select(
    year,
    # binary respone
    current_vaping,
    # possible predictor
    borough,
    age,
    sex,
    race7,
    sad_hopeless,
    attempted_suicide,
    injurious_suicide_attempt,
    considered_suicide,
    safety_concerns_at_school,
    threatened_at_school,
    physical_fighting,
    bullying_at_school,
    bullying_electronically,
    illegal_injected_drug_use,
    carring_weapon,
    sex_before_13,
    current_sexual_activity) %>%
    #### Basing model on data from 2015
  filter(year == 2015) %>% 
    ### we do our anaylsis on complete datasets
  drop_na()
```



# Method 1: Manual Selection

```{r Manuel_Method}
# Fitting a logistic regression model
fit_logistic = glm(current_vaping ~ sad_hopeless  + attempted_suicide + safety_concerns_at_school + illegal_injected_drug_use + physical_fighting + bullying_electronically + carring_weapon + sex_before_13 , data = df, family = binomial(),na.action = na.omit)

# Looking at the model coefficients
fit_logistic %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate)) %>%
  knitr::kable(digits = 3)
```

```{r Model_Criteria}
# What is the contribution of each predictor? see: https://uc-r.github.io/logistic_regression#multi
caret::varImp(fit_logistic)

# Cross-Validating the model
data_train <- trainControl(method = "cv", number = 5)

model_caret <- train(
  current_vaping ~ sad_hopeless  + attempted_suicide + safety_concerns_at_school + threatened_at_school + physical_fighting + bullying_electronically + carring_weapon,
                   data = df,
                   trControl = data_train,
                   method = 'glm',
                   family = binomial(),
                   na.action = na.pass)
  
model_caret
AIC(fit_logistic)


fit_logistic$formula
```

Model 1: current_vaping ~ sad_hopeless + attempted_suicide + safety_concerns_at_school + 
    illegal_injected_drug_use + physical_fighting + bullying_electronically + 
    carring_weapon + sex_before_13



# Method 2: Step AIC regression generatoion
```{r}

###Defining a glm object that contains the regression model generated
auto_logistic = glm(
  ###Fixing "current_vaping" as response,whith all the vairble candidtates as pridictors.
  current_vaping ~., data = df, 
  ###Runing logistics regression, with complete analysis
  family = binomial(),na.action = na.omit) %>%
  ###Choose a model by AIC in a Stepwise Algorithm
  MASS::stepAIC(trace = FALSE)

AIC(auto_logistic)

auto_logistic %>% broom::tidy()
auto_logistic$formula
```
Model 2: current_vaping ~ sex + race7 + sad_hopeless + attempted_suicide + 
    safety_concerns_at_school + physical_fighting + illegal_injected_drug_use + 
    carring_weapon + sex_before_13 + current_sexual_activity



# Method 3:Lasso regression generation
```{r}
###Defining a glmnet object that contains the cv lasso model generated to find the best lambda to use
  lasso_temp = cv.glmnet(
  ###Fixing "current_vaping" as response,whith all the vairble candidtates as pridictors.
    current_vaping ~., data = df, 
    ###Runing for logistics outcom
    family = "binomial")

###Defining a glmnet object that contains the final lasso model using the best lambda generated
  lasso_logistic = glmnet(
  ###Fixing "current_vaping" as response,whith all the vairble candidtates as pridictors.
    current_vaping ~., data = df, 
    ###Runing for logistics outcom
    family = "binomial",
    ### With the best lambda
    lambda = lasso_temp$lambda.min
    )


#See the accuracy of prediction with this model
lasso_logistic %>% broom::tidy()
```
Model 3: 


